# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

A JSII-enabled CDK construct library that deploys VS Code Server on AWS. Published to npm and PyPI. Designed for workshop/development environments with intentionally permissive security for ease of use.

**Key Characteristic**: This is **NOT production-ready** by design - it's optimized for quick workshop setup and learning environments.

## Projen-Managed Project

**Critical**: ALL project configuration is in `.projenrc.ts`. After modifying it, run `npx projen` to regenerate managed files.

**Never manually edit**:
- `package.json`
- Task definitions
- GitHub workflows
- Any file with "~~ Generated by projen" header

## Development Commands

### Build and Test
```bash
# Full build (compiles TS, bundles Lambdas, generates API docs)
npx projen build

# Run unit tests
npx projen test

# Run single test file
npx jest test/vscode-server.test.ts

# Watch mode for tests
npx projen test:watch

# Integration tests (deploys to eu-west-1, eu-west-2, eu-north-1, eu-west-3)
npm run integ-test
```

### Code Quality
```bash
# ESLint
npx projen eslint

# AWS CDK-specific linting (awslint rules)
npm run awslint
```

### Lambda Development
```bash
# Bundle specific Lambda
npx projen bundle:installer/installer.lambda
npx projen bundle:idle-monitor/idle-monitor.lambda
npx projen bundle:idle-monitor-enabler/idle-monitor-enabler.lambda
npx projen bundle:secret-retriever/secret-retriever.lambda

# Watch mode for Lambda development
npx projen bundle:installer/installer.lambda:watch
```

### Publishing
```bash
# Package for all targets (npm, Python)
npx projen package-all

# Package specific target
npx projen package:js
npx projen package:python
```

## Architecture Overview

### Main Construct: `VSCodeServer` (src/vscode-server.ts)

Orchestrates the entire infrastructure:
- VPC with single public subnet
- EC2 instance (default: m7g.xlarge Graviton3 ARM)
- CloudFront distribution with custom cache policies
- Security groups (CloudFront prefix list restriction only)
- IAM role with broad CDK permissions (workshop-friendly)
- Optional: Route53 + ACM certificate integration
- Optional: Auto-stop feature with idle monitoring

### Custom Resource Pattern

Uses Lambda-backed custom resources via CDK Provider construct:

1. **Installer** (`src/installer/`)
   - Runs SSM documents to install VS Code Server
   - OS-specific installation for Ubuntu 22/24 and Amazon Linux 2023
   - Returns SUCCESS when installation completes
   - Custom resource name: `SSMInstallerCustomResource`

2. **SecretRetriever** (`src/secret-retriever/`)
   - Extracts generated password from Secrets Manager
   - Returns password as CloudFormation output

3. **PrefixListRetriever** (`src/prefixlist-retriever/`)
   - Fetches AWS-managed CloudFront prefix lists
   - Used to restrict security group ingress

4. **IdleMonitorEnabler** (`src/idle-monitor-enabler/`)
   - Enables EventBridge rule ONLY after installation completes
   - Prevents race condition where IdleMonitor stops instance mid-installation
   - Critical dependency chain: `Installer → IdleMonitorEnabler → IdleMonitor active`

### Auto-Stop Feature Architecture

**Problem Solved**: Race condition where IdleMonitor could stop instance during installation.

**Solution Flow**:
1. EventBridge rule created in **DISABLED** state (`src/idle-monitor/idle-monitor.ts:118`)
2. Installer runs and completes VS Code Server setup
3. IdleMonitorEnabler custom resource **enables** the rule after installation succeeds
4. IdleMonitor now safely monitors CloudFront metrics for idle detection

**Key Files**:
- `src/idle-monitor/idle-monitor.ts` - EventBridge rule + Lambda for monitoring
- `src/idle-monitor/idle-monitor.lambda.ts` - Checks CloudWatch metrics, stops instance if idle
- `src/idle-monitor-enabler/idle-monitor-enabler.ts` - Custom resource construct
- `src/idle-monitor-enabler/idle-monitor-enabler.lambda.ts` - Enables EventBridge rule via AWS SDK

**Dependency Wiring** (`src/vscode-server.ts:984`):
```typescript
const installerCustomResource = this.node.findChild('SSMInstallerCustomResource');
enabler.node.addDependency(installerCustomResource);
```

### AMI Selection (`src/mappings.ts`)

Contains SSM parameter paths for:
- Ubuntu 22/24 (ARM + x86_64)
- Amazon Linux 2023 (ARM + x86_64)

Function `getAmiSSMParameterForLinuxArchitectureAndFlavor()` returns region-specific SSM parameter for latest AMI.

### Key Props (`src/vscode-server.ts:27-200`)

**Instance Configuration**:
- `instanceClass`, `instanceSize`, `instanceVolumeSize`
- `instanceOperatingSystem` (LinuxFlavorType enum)
- `instanceCpuArchitecture` (LinuxArchitectureType enum)

**VS Code Configuration**:
- `vscodeUser`, `vscodePassword`, `homeFolder`
- `devServerPort`, `devServerBasePath`

**Domain/Certificate**:
- `domainName`, `hostedZoneId`, `certificateArn`, `autoCreateCertificate`

**Auto-Stop**:
- `enableAutoStop` - Enable automatic instance stop when idle
- `idleTimeoutMinutes` - Minutes of inactivity before stopping (default: 30)
- `idleCheckIntervalMinutes` - How often to check (default: 5)
- `skipStatusChecks` - Skip EC2 status checks before stopping (for testing only)

**Extensions**:
- `additionalInstanceRolePolicies`, `additionalTags`

## JSII Constraints

**Critical for JSII compatibility**:
- All public APIs must be JSII-compatible (no TS-specific types)
- Bundled dependencies (like `node-html-parser`) must be in `.projenrc.ts` `bundledDeps`
- Lambda functions use esbuild bundling configured via Projen (auto-discovered in `src/**/*.lambda.ts`)

## CDK-nag Integration

Suppressions defined in `src/suppress-nags.ts` and applied throughout construct code.

**Why suppressions are needed**: Workshop design intentionally violates production best practices:
- Broad IAM permissions for ease of use
- Permissive security groups
- Public subnet deployment
- No VPC endpoints

Apply suppressions via `NagSuppressions.addResourceSuppressions()`.

## Integration Tests

Located in `integ-tests/`, using `@aws-cdk/integ-tests-alpha` framework.

**Test Files**:
- `integ.ubuntu.ts` - Basic Ubuntu 22 deployment + login test
- `integ.al2023.ts` - Amazon Linux 2023 deployment
- `integ.custom-domain.ts` - Custom domain + ACM certificate
- `integ.stop-on-idle.ts` - **4-phase auto-stop workflow test**

**Stop-on-Idle Test Phases** (`integ-tests/integ.stop-on-idle.ts`):
1. `verify-auto-stop` - Wait for instance to stop after idle timeout
2. `disable-idle-monitor` - Disable EventBridge rule to prevent re-stopping
3. `start-instance` - Start instance and wait for running state
4. `verify-login` - Check VS Code Server accessibility via CloudFront

**Run Integration Tests**:
```bash
npm run integ-test  # Deploys to 4 regions in parallel
```

**Important**: Integration tests deploy actual stacks and incur AWS costs.

## Lambda Bundling

Projen automatically discovers Lambda functions matching `src/**/*.lambda.ts` pattern.

**Auto-generated tasks** for each Lambda:
- `bundle:<path>/name.lambda` - Bundle Lambda code
- `bundle:<path>/name.lambda:watch` - Watch mode for development

**Bundled output**: `assets/<path>/name.lambda/index.js`

## Common Workflows

### Adding a New Lambda Function

1. Create `src/my-feature/my-feature.lambda.ts`
2. Create `src/my-feature/my-feature-function.ts` (CDK construct wrapper)
3. Run `npx projen` - auto-discovers and creates bundle task
4. Import in construct: `import { MyFeatureFunction } from './my-feature/my-feature-function'`

### Modifying VSCodeServer Props

1. Edit `src/vscode-server.ts` - update `VSCodeServerProps` interface
2. Run `npx projen build` - regenerates JSII artifacts + API docs
3. Update README.md with usage examples

### Testing Changes

1. Unit tests: `npx jest test/vscode-server.test.ts`
2. Build validation: `npx projen build` (includes awslint checks)
3. Integration test: `npm run integ-test` (full deployment test)

## Race Condition Prevention (Auto-Stop)

**Issue**: IdleMonitor EventBridge rule triggers immediately on stack creation, potentially stopping instance during installation (observed: instance stopped 72 seconds after installer started).

**Fix**: Three-stage dependency chain ensures safe operation:

```
EC2 Instance
    ↓
Installer Custom Resource (waits for VS Code Server installation)
    ↓
IdleMonitorEnabler Custom Resource (enables EventBridge rule)
    ↓
IdleMonitor Active (now safe to monitor)
```

**Implementation Details**:
- EventBridge rule created with `enabled: false` (`src/idle-monitor/idle-monitor.ts:118`)
- IdleMonitorEnabler depends on `SSMInstallerCustomResource` via `node.addDependency()`
- CloudFormation enforces ordering automatically

This pattern can be applied to any future features requiring post-installation activation.

## Multi-Language Publishing

Project publishes to:
- **npm**: `@mavogel/cdk-vscode-server`
- **PyPI**: `cdk-vscode-server`

JSII compiles TypeScript to:
- JavaScript (npm)
- Python (PyPI)

**Publishing** (requires credentials):
```bash
npx projen release
```

## Workshop-Specific Considerations

**Remember**: This construct is intentionally designed for workshops, NOT production:

- IAM roles have broad permissions (all CDK operations)
- Security groups allow CloudFront only (but permissive within that constraint)
- No private subnets or VPC endpoints (cost optimization for workshops)
- Single public subnet (simplicity over high availability)
- Password-based authentication (ease of use over MFA/SSO)

When reviewing changes, prioritize **ease of use** and **quick setup** over security hardening.
